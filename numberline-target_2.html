<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ナンバーラインターゲット</title>
<style>
:root {
  --bg1:#05080f;
  --bg2:#0c1629;
  --accent:#e11d48;
  --good:#22c55e;
  --mid:#f59e0b;
  --bad:#ef4444;
  --label:#e6eefc;
}
html,body {
  height:100%; margin:0;
  font-family:"Noto Sans JP","Segoe UI",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--label);
  display:flex;flex-direction:column;align-items:center;
  overflow:hidden;
}

/* --- スタート画面 --- */
#startScreen {
  position:fixed;inset:0;
  background:linear-gradient(180deg,rgba(5,8,15,0.9),rgba(12,22,41,0.9));
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:50;
}
#title {font-size:2.3rem;font-weight:900;margin-bottom:10px;}
#subtitle {font-size:1rem;color:#9fb3d6;margin-bottom:18px;text-align:center;max-width:80%;}
.big-diff {display:flex;gap:18px;}
.diff-btn {
  min-width:150px;padding:18px 22px;border:none;border-radius:14px;
  cursor:pointer;font-size:1.05rem;font-weight:900;color:#fff;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
  transition:transform .12s, box-shadow .12s;
}
.diff-btn:hover {transform:translateY(-6px);}
.diff-btn.easy {background:linear-gradient(180deg,#0b3b2e,#095c44);}
.diff-btn.normal {background:linear-gradient(180deg,#7a4d0a,#b06207);}
.diff-btn.hard {background:linear-gradient(180deg,#58151b,#7a1f2b);}
#startInfo {color:#9fb3d6;margin-top:14px;font-size:0.95rem;}

/* --- HUD --- */
header {width:100%;max-width:960px;margin-top:8px;display:flex;justify-content:space-between;align-items:center;}
.title-hud {font-weight:800;}
.hud {width:100%;max-width:960px;margin-top:10px;display:flex;justify-content:space-between;}
.badge {background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;font-weight:800;}
.instruction {font-size:1.25rem;margin:12px 0;text-align:center;min-height:2rem;}

/* --- 数直線 --- */
.line-wrap {
  position:relative;
  width:80vw;
  height:260px;
  padding:0 40px;
  display:flex;
  align-items:center;
  justify-content:center;
  touch-action:none;
  overflow:visible;
}
.line-track {
  position:relative;
  width:100%;
  height:16px;
  border-radius:10px;
  background:linear-gradient(90deg,#d7dbe2,#f5f8ff 40%,#c4c9d1);
  box-shadow:0 0 25px rgba(0,255,255,0.3),
             inset 0 3px 8px rgba(255,255,255,0.4),
             inset 0 -3px 8px rgba(0,0,0,0.5);
  overflow:visible;
}
.endpoint {
  position:absolute;top:50%;
  font-weight:900;font-size:1.4rem;
  color:#fff;
  text-shadow:0 0 10px rgba(255,255,255,0.8);
  z-index:1;
  white-space:nowrap;
}
.endpoint.left  { left:0;  transform:translate(-10%,-180%); }
.endpoint.right { right:0; transform:translate(10%,-180%); }

/* --- 目盛り --- */
.tick {
  position:absolute;
  top:50%;
  width:2px;
  height:12px;
  background:#a8b4cc;
  transform:translateY(-50%);
  opacity:0.6;
  z-index:0;
}

/* --- 目盛りON/OFFボタン --- */
.toggle-ticks {
  position:fixed;
  top:12px; right:12px;
  padding:8px 14px;
  font-weight:700;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:10px;
  color:#fff;
  cursor:pointer;
  z-index:100;
  transition:background 0.2s;
}
.toggle-ticks:hover {background:rgba(255,255,255,0.18);}

/* --- スコープ効果 --- */
.scope {
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:200px;height:200px;
  border-radius:50%;
  box-shadow:0 0 40px rgba(255,0,0,0.05);
  transition:all 0.25s ease-out;
  pointer-events:none;
}
.scope.flash {
  box-shadow:0 0 80px rgba(255,255,150,0.4);
  transform:translate(-50%,-50%) scale(1.15);
}

/* --- 各種演出 --- */
.popup {
  position:fixed;font-weight:900;animation:popup 800ms forwards;
  text-shadow:0 2px 8px rgba(0,0,0,0.5);
}
@keyframes popup {
  0% {opacity:1;transform:translateY(0) scale(1);}
  100% {opacity:0;transform:translateY(-60px) scale(1.05);}
}
.feedback {
  position:fixed;left:50%;top:40%;transform:translateX(-50%);
  font-size:3rem;font-weight:900;opacity:0;transition:opacity .1s;
  pointer-events:none;
}
.feedback.show {opacity:1;}
.result-modal {
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  background:#0c1424;padding:22px;border-radius:14px;display:none;
  text-align:center;color:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.6);
}
.result-modal.show {display:block;}
.fraction {display:inline-block;text-align:center;}
.fraction .top {display:block;}
.fraction .bar {display:block;border-top:2px solid #fff;width:1.2em;margin:2px auto;}
.fraction .bottom {display:block;}
</style>
</head>
<body>

<!-- 目盛りON/OFFボタン -->
<button id="toggleTicks" class="toggle-ticks">目盛りON</button>

<div id="startScreen">
  <div id="title">ナンバーラインターゲット</div>
  <div id="subtitle">スナイパーのように狙い、正確に撃ち抜け！<br>60秒タイムアタック</div>
  <div class="big-diff">
    <button class="diff-btn easy" data-mode="easy">やさしい</button>
    <button class="diff-btn normal" data-mode="normal">ふつう</button>
    <button class="diff-btn hard" data-mode="hard">むずかしい</button>
  </div>
  <div id="startInfo">難易度を選んでスタート！</div>
</div>

<header><div class="title-hud">🎯 ナンバーラインターゲット</div></header>
<div class="hud">
  <div class="badge" id="scoreBadge">スコア: 0</div>
  <div class="badge" id="comboBadge">COMBO: 0</div>
  <div class="badge" id="timerBadge">残り: 60s</div>
  <div class="badge" id="modeBadge">難易度: -</div>
</div>

<main>
  <div class="instruction" id="instruction">難易度を選んで開始してください</div>
  <div class="line-wrap" id="lineWrap">
    <div class="line-track" id="lineTrack">
      <div class="endpoint left"  id="leftLabel">0</div>
      <div class="endpoint right" id="rightLabel">100</div>
    </div>
    <div class="scope" id="scope"></div>
  </div>
</main>

<div class="feedback" id="feedback"></div>
<div class="result-modal" id="resultModal">
  <h2>タイムアップ！</h2>
  <div id="finalScore">スコア: 0</div>
  <div id="rankText" style="font-size:2rem;font-weight:900;color:#ffd166">C</div>
  <button id="retryBtn">タイトルに戻る</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const diffBtns=document.querySelectorAll(".diff-btn");
  const startScreen=document.getElementById("startScreen");
  const instruction=document.getElementById("instruction");
  const scoreBadge=document.getElementById("scoreBadge");
  const comboBadge=document.getElementById("comboBadge");
  const timerBadge=document.getElementById("timerBadge");
  const modeBadge=document.getElementById("modeBadge");
  const lineTrack=document.getElementById("lineTrack");
  const lineWrap=document.getElementById("lineWrap");
  const leftLabel=document.getElementById("leftLabel");
  const rightLabel=document.getElementById("rightLabel");
  const feedback=document.getElementById("feedback");
  const scope=document.getElementById("scope");
  const resultModal=document.getElementById("resultModal");
  const finalScore=document.getElementById("finalScore");
  const rankText=document.getElementById("rankText");
  const retryBtn=document.getElementById("retryBtn");
  const toggleBtn=document.getElementById("toggleTicks");

  let mode="easy",score=0,combo=0,timeLeft=60,timerId=null,awaiting=false,currentUpper=10,currentTarget=0;
  let ticksVisible=false;

  /* --- 目盛り機能 --- */
  function drawTicks(){
    clearTicks();
    const numTicks=10;
    for(let i=1;i<numTicks;i++){
      const tick=document.createElement("div");
      tick.className="tick";
      tick.style.left=`${(i/numTicks)*100}%`;
      lineTrack.appendChild(tick);
    }
  }
  function clearTicks(){
    lineTrack.querySelectorAll(".tick").forEach(el=>el.remove());
  }
  toggleBtn.addEventListener("click",()=>{
    ticksVisible=!ticksVisible;
    if(ticksVisible){drawTicks();toggleBtn.textContent="目盛りOFF";}
    else {clearTicks();toggleBtn.textContent="目盛りON";}
  });
  window.addEventListener("resize",()=>{if(ticksVisible) drawTicks();});

  /* --- 以下ゲーム処理は既存ロジック --- */
  const AudioCtx=window.AudioContext||window.webkitAudioContext;const ctx=new AudioCtx();

  function playTone(f,d,vol=0.2,type="triangle"){
    const o=ctx.createOscillator();const g=ctx.createGain();
    o.type=type;o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
    g.gain.setValueAtTime(vol,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);
    o.start();o.stop(ctx.currentTime+d);
  }
  function goodSound(){const base=300+(combo*60);playTone(base,0.18,0.18,"triangle");setTimeout(()=>playTone(base+120,0.12,0.15,"triangle"),100);}
  function perfectSound(){const base=450+(combo*90);playTone(base,0.2,0.25,"sine");setTimeout(()=>playTone(base+200,0.15,0.22,"triangle"),100);}
  function missSound(){playTone(180,0.25,0.15,"sine");}
  function timeUp(){playTone(100,0.5,0.25,"square");}

  diffBtns.forEach(b=>b.addEventListener("click",()=>{
    if(ctx.state==="suspended")ctx.resume();
    mode=b.dataset.mode;
    modeBadge.textContent="難易度: "+(mode==="easy"?"やさしい":mode==="normal"?"ふつう":"むずかしい");
    startScreen.style.display="none";
    startGame();
  }));

  function startGame(){
    score=0;combo=0;timeLeft=60;awaiting=false;
    scoreBadge.textContent="スコア: 0";comboBadge.textContent="COMBO: 0";timerBadge.textContent="残り: 60s";
    newQuestion();
    timerId=setInterval(()=>{timeLeft--;timerBadge.textContent=`残り: ${timeLeft}s`;if(timeLeft<=0){clearInterval(timerId);finishGame();}},1000);
  }

  function pickFraction(u){const d=[2,3,4,5,8,10];const den=d[Math.floor(Math.random()*d.length)];const num=Math.ceil(Math.random()*(den-1));return{num,den,val:(num/den)*u};}
  function pickUpper(){if(mode==="easy")return 10;if(mode==="normal")return 100;return [10,20,50,100][Math.floor(Math.random()*4)];}

  function newQuestion(){
    awaiting=false;const u=pickUpper();currentUpper=u;
    leftLabel.textContent="0";rightLabel.textContent=String(u);
    const r=Math.random();
    if(mode==="hard"&&r>0.6){const f=pickFraction(u);currentTarget=f.val;instruction.innerHTML=`「 <span class='fraction'><span class='top'>${f.num}</span><span class='bar'></span><span class='bottom'>${f.den}</span></span> を狙え！」`;}
    else{const v=Math.floor(Math.random()*(u+1));currentTarget=v;instruction.textContent=`「 ${v} を狙え！」`;}
  }

  function compute(norm){
    const val=norm*currentUpper;const dist=Math.abs(val-currentTarget);const dnorm=dist/currentUpper;
    if(dnorm>0.18)return{score:0,perfect:false};
    const base=Math.max(0,1-Math.pow(dnorm,1.7));
    let s=Math.round(100*base);let perfect=false;
    if(dnorm<=0.02){s=Math.min(150,s+50);perfect=true;}
    return{score:s,perfect};
  }

  function popup(x,y,text,color){const p=document.createElement("div");p.className="popup";p.style.left=`${x}px`;p.style.top=`${y}px`;p.style.color=color;p.textContent=text;document.body.appendChild(p);setTimeout(()=>p.remove(),800);}
  function scopeFlash(){scope.classList.add("flash");setTimeout(()=>scope.classList.remove("flash"),200);}

  lineWrap.addEventListener("pointerdown",ev=>{
    if(awaiting)return;
    const rect=lineTrack.getBoundingClientRect();
    const norm=(ev.clientX-rect.left)/rect.width;
    const result=compute(norm);
    awaiting=true;

    if(result.score>0){
      score+=result.score;
      combo++;
      scopeFlash();
      if(result.perfect){perfectSound();feedback.textContent="PERFECT!";feedback.style.color="gold";}
      else{goodSound();feedback.textContent="GOOD!";feedback.style.color="lime";}
      feedback.classList.add("show");setTimeout(()=>feedback.classList.remove("show"),300);
      popup(ev.clientX,ev.clientY,"+"+result.score,"#ffd166");
    }else{
      missSound();
      combo=0;
      feedback.textContent="惜しい…";
      feedback.style.color="#aaa";
      feedback.classList.add("show");setTimeout(()=>feedback.classList.remove("show"),300);
      popup(ev.clientX,ev.clientY,"0","#999");
    }

    scoreBadge.textContent=`スコア: ${score}`;
    comboBadge.textContent=`COMBO: ${combo}`;
    setTimeout(()=>{awaiting=false;newQuestion();},600);
  });

  function finishGame(){
    clearInterval(timerId);
    timeUp();
    finalScore.textContent=`スコア: ${score}`;
    let rank="C";
    if(score>1200)rank="S";else if(score>900)rank="A";else if(score>600)rank="B";
    rankText.textContent=rank;
    resultModal.classList.add("show");
  }

  retryBtn.addEventListener("click",()=>{
    resultModal.classList.remove("show");
    startScreen.style.display="flex";
    instruction.textContent="難易度を選んで開始してください";
  });
});
</script>
</body>
</html>
